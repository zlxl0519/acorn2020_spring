<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cafeComment">
	<select id="getList" parameterType="cafeCommentDto" resultType="cafeCommentDto">
		select *
		from
			(select result1.*, rownum as rnum
			from
				(select num, writer, content, target_id, ref_group, 
					comment_group, deleted, board_cafe_comment.regdate, profile
				from board_cafe_comment 
				inner join users
				on board_cafe_comment.writer=users.id
				where ref_group=#{ref_group}
				order by comment_group asc, num asc) result1)
		where rnum between #{startRowNum} and #{endRowNum}
	</select>
	<!--
		inner join users on board_cafe_comment.writer=users.id (on 조인 조건) 
		order by comment_group 은 댓글들이 몰려있도록 하고 숫자가 같으니까, num 은  그 그룹안에서 정렬 
		Dto 는 DB에 테이블과 1대1 매칭으로 하지 않아도 된다.
	-->
	<update id="delete" parameterType="int">
		update board_cafe_comment
		set deleted='yes'
		where num=#{num}
	</update>
	<insert id="insert" parameterType="cafeCommentDto">
		insert into board_cafe_comment
		(num, writer, content, target_id, ref_group, comment_group, regdate)
		values(#{num}, #{writer}, #{content}, #{target_id}, #{ref_group},
			 #{comment_group}, sysdate)
	</insert>
	<!-- num 과 comment_group 의 번호를 같은 번호를 넣기 위해 insert 하기 전에 sequence 값을 가져 와서 넣어주어야 한다. -->
	<select id="getSequence" resultType="int">
		select board_cafe_comment_seq.nextval
		from dual
	</select>
	<update id="update" parameterType="cafeCommentDto">
		update board_cafe_comment
		set content=#{content}
		where num=#{num}
	</update>
	<select id="getData" parameterType="int" resultType="cafeCommentDto">
		select num, writer, content, ref_group, comment_group, deleted, regdate
		from board_cafe_comment
		where num=#{num}
	</select>
	<select id="getCount" parameterType="int" resultType="int" >
		select nvl(max(rownum),0)
		from board_cafe_comment
		where ref_group=#{ref_group}
		order by comment_group asc, num asc
	</select>
</mapper>